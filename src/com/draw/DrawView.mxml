<?xml version="1.0" encoding="utf-8"?>
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009" 
		xmlns:s="library://ns.adobe.com/flex/spark"
		addedToStage="addedToStageHandler(event)"
		removedFromStage="removedFromStageHandler(event)"
		width="100%" height="100%"> 
	
	<s:layout>
		<s:BasicLayout />
	</s:layout>
	
	<fx:Script>
		<![CDATA[
			import mx.core.UIComponent;
			import mx.events.EffectEvent;
			
			import spark.components.Image;
			import spark.primitives.Rect;
			
			//http://saturnboy.com/2010/06/drawer-component-flex-4/
			//http://www.munkiihouse.com/?p=37
			
			private var isDrawerOpen : Boolean = false
			
			private var _frontView : UIComponent;
			
			private var frontViewChanged : Boolean;
			
			public function set frontView(component : UIComponent):void
			{
				_frontView = component;
				
				frontViewChanged = true;
			}
			
			public function get frontView():*
			{
				return _frontView;
			}
			
			private var _drawView : *;
			
			private var drawViewChanged : Boolean = false;

			public function get drawView():*
			{
				return _drawView;
			}

			public function set drawView(value:*):void
			{
				_drawView = value;
				
				drawViewChanged = true;
			}
			
			override protected function commitProperties():void
			{
				super.commitProperties();
				
				if (frontViewChanged)
				{
					holderFrontView.addElement(frontView);
					effectShowDraw.targets = [holderFrontView, this.navigator.actionBar];
					
					frontViewChanged = false;
				}
				
				if (drawViewChanged)
				{
					holderDrawerView.addElement(drawView);
					
					drawViewChanged = false;
				}
				
			}
			
			protected function addedToStageHandler(event:Event):void
			{
				Multitouch.inputMode = MultitouchInputMode.GESTURE;
				stage.addEventListener(TransformGestureEvent.GESTURE_PAN, onPanHandler);
				
				addEventListener(MouseEvent.CLICK, onMouseClickHandler);
			}
			
			private function onPanHandler(event : TransformGestureEvent):void
			{
				/* if (event.offsetY < 0)
				{
					effectShowDraw.play();
				}
				else
				{
					
				} */
			}
			
			private function onMouseClickHandler(event : MouseEvent):void
			{
				if (!this.isDrawerOpen)
				{
					this.navigator.hideActionBar(true);
					effectShowDraw.play();
				}
				else
				{
					this.navigator.showActionBar(true);
					effectShowDraw.play(null, true);
					holderFrontView.filters = [];
					holderFrontView.enabled = true;
				}
			}
			
			protected function removedFromStageHandler(event:Event):void
			{
				stage.removeEventListener(TransformGestureEvent.GESTURE_PAN, onPanHandler);
			}
			
			protected function frontViewCover_mouseDownHandler(event:MouseEvent):void
			{
				event.stopImmediatePropagation();
			}
			
			protected function effectShowDraw_effectEndHandler(event:EffectEvent):void
			{
				this.isDrawerOpen = !isDrawerOpen;
				
				var uiBitmapData : BitmapData = new BitmapData(holderFrontView.width, holderFrontView.height);
				uiBitmapData.draw(holderFrontView, new Matrix());
				var coverImage : Image = new Image;
				coverImage.source = new Bitmap(uiBitmapData);
				holderFrontView.addElement(coverImage);
				coverImage.addEventListener(MouseEvent.CLICK, onCoverImageClickHandler);
				
				removeEventListener(MouseEvent.CLICK, onMouseClickHandler);
			}
			
			protected function onCoverImageClickHandler(event : MouseEvent):void
			{
				
			}
			
			protected function effectShowDraw_effectStartHandler(event:EffectEvent):void
			{
				trace(this.navigator.actionBar.y)
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<s:Parallel id="effectShowDraw" 
					duration="300"
					suspendBackgroundProcessing="true"
					effectStart="effectShowDraw_effectStartHandler(event)"
					effectEnd="effectShowDraw_effectEndHandler(event)">
			<s:children>
				<s:Move id="moveFrontView" 
						yFrom="0" 
						yTo="-80"/>
				<s:Fade id="fadeFrontView" alphaFrom="1" alphaTo=".6"/>
			</s:children>
		</s:Parallel>
	</fx:Declarations>
	
	<s:Group id="holderDrawerView"
			 width="100%"
			 bottom="0"/>
	
	<s:Group id="holderFrontView"
			 width="100%"
			 height="100%">
		<!--<s:layout>
			<s:HorizontalLayout horizontalAlign="center"
								verticalAlign="middle"/>
		</s:layout>
		<s:Button label="Yarrr!!!"/>-->
	</s:Group>
	
</s:View>
